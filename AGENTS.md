# Repository Guidelines

## Project Structure & Module Organization
- `src/` holds production code split by responsibility: `mediastream` (I/O), `posedetector` (MediaPipe inference), `datastream` (CSV export), `visualizedata` (3D plotting), plus helper packages for augmentation and streaming utilities.
- `main.py` wires these modules together; update the `name` variable or extend it with CLI args when pointing to a new clip.
- `data/input/` and `data/output/` store raw videos and generated CSVs respectively, while `models/` ships with `pose_landmarker_heavy.task`.
- Keep exploratory analyses inside `notebooks/` and guard large intermediate files within `data/` so they are not added to Git.
- Tests belong under `tests/` and should mirror the structure of `src/` for easy discovery.

## Build, Test, and Development Commands
- `uv sync` installs the Python 3.12 toolchain defined in `pyproject.toml`/`uv.lock`.
- `uv run python main.py --video data/input/<name>.mp4 --height <m> --mass <kg> --age <years> --sex <male|female>` runs the full pipeline, producing CSV/TRC artifacts under `data/output/pose-3d/<name>/`.
- `uv run pytest` executes the unit test suite (add `-k module_name` when targeting a single component).
- `uv run jupyter lab notebooks/` launches the notebook workspace with repository packages on the path for quick prototyping.

## Pipeline Flags & Visualization
- `--show-video` renders a MediaPipe preview window *and* writes `<name>_preview.mp4` when GUI support is missing (requires Qt/XCB libs and optionally ffmpeg for MP4 export).
- `--plot-landmarks` replays the extracted CSV landmarks via Matplotlib; omit or add `--no-plot` to skip GUI work during batch runs.
- `--plot-augmented` visualizes the Pose2Sim augmented TRC and exports `<name>_LSTM_preview.mp4` (falls back to GIF if ffmpeg is unavailable).
- `--fix-header` rewrites TRC metadata for downstream OpenSim tools.

## Coding Style & Naming Conventions
- Follow PEP 8 with 4-space indentation, descriptive snake_case names, and type-hinted function signatures as seen across `src/`.
- Keep modules cohesive: each package should expose a single public class (e.g., `MediaStream`, `PoseDetector`) and raise clear exceptions on invalid input.
- Provide concise docstrings for public methods and add inline comments only when the intent is non-obvious (e.g., FPS assumptions).
- Format code before committing; `uv run python -m black src tests` is the recommended baseline.

## Testing Guidelines
- Use `pytest` with files named `test_<module>.py` that mirror the corresponding package (e.g., `tests/test_media_stream.py`).
- Prefer deterministic fixtures built from short sample videos stored under `data/input/tests/` to keep runs fast.
- Aim for coverage on parsing, error handling, and visualization helpers; mock OpenCV/MediaPipe calls when integration tests would be too heavy.
- Document new test datasets or golden CSVs in the PR description so reviewers can reproduce results.

## Commit & Pull Request Guidelines
- Write imperative, scoped commit messages (e.g., `mediastream: validate fps metadata`) and keep unrelated changes in separate commits.
- Every PR needs a brief summary, validation notes (commands executed), references to any tracked issues, and screenshots/GIFs for visualization changes.
- Request review from another contributor before merging and ensure CI (pytest + lint) has a green run attached to the PR.

## Known Follow-ups / Notes
- Pose2Sim expects the full OpenCap marker layout; `ORDER_22` now matches its feature set but we still need to derive the additional `response_markers` so the augmented skeleton draws cleanly (requires consulting Pose2Sim docs with network access).
- The autogenerated Pose2Sim `Config.toml` is minimal; drop in a project-specific config if you need filtering, c3d exports, or adjusted anthropometrics.
- Visualization/export code uses ffmpeg when present; otherwise it falls back to Pillow GIFs. Install `ffmpeg` system-wide for MP4 output.
