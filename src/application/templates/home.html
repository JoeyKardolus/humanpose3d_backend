{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KinetIQ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'styles.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
  <script defer src="{% static 'main.js' %}"></script>
</head>
<body class="page-body">
  <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsTitle" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <p class="label mb-1 text-success">Instructions</p>
            <h2 class="modal-title h4 fw-semibold" id="instructionsTitle">Read before you continue</h2>
          </div>
        </div>
        <div class="modal-body">
          <p class="fst-italic">Thanks for using this application to quantify human movement. This application uses computer vision to identify and key anatomical landmarks in estimated 3D space.</p>
          <p class="label fw-medium">Quality of tracking is heavily affected by the following factors</p>
          <ul>
            <li>Let the subject wear tight and short clothes — tighter and shorter is better.</li>
            <li>Be sure to record clips in high frame rates (fps). Slower movements can be captured with 30fps; very fast movements, use up to 120fps.</li>
            <li>Higher definition recording will positively influence the results, but processing will take longer. 4K recording is not required.</li>
            <li>If possible, set shutter speed at roughly double the frame rate (for example, 1/60s when recording at 30fps).</li>
            <li>Be sure the object has high contrast with the environment; avoid black clothes.</li>
            <li>Be sure lighting is good; poor lighting will lead to poorer results.</li>
            <li>Avoid multiple human subjects (or images with humans depicted) in the background; they negatively affect results.</li>
            <li>Match camera view to the plane of interest; ~45° frontal-lateral works well if you want both sagittal and frontal views.</li>
            <li>Be sure the whole body is captured; missing limbs (e.g., raised arms) will heavily affect results.</li>
            <li>Be sure that the camera is not tilted or moving during capture.</li>
            <li>Position your camera in landscape.</li>
            <li>Limit your capture time to about 1 minute.</li>
          </ul>
        </div>
        <div class="modal-footer justify-content-between flex-wrap">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="instructions-check">
            <label class="form-check-label" for="instructions-check">
              I have read and accept these instructions.
            </label>
          </div>
          <button class="btn btn-primary" data-next="notice">Continue</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="noticeModal" tabindex="-1" aria-labelledby="noticeTitle" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <p class="label mb-1 text-success">Quick Note</p>
            <h2 class="modal-title h4 fw-semibold" id="instructionsTitle">Ethics and privacy instructions</h2>
          </div>
        </div>
        <div class="modal-body">
          <p>Using a video recording to analyse a human’s body can contain privacy-sensitive information. Be sure that the subject gives informed consent for the recording and analysis of the movement. For each new analysis, you are required to tick the box related to this privacy statement. In addition, when analysis is done according to your satisfaction, remove the videos that contain privacy-sensitive information from your device.</p>
          <p>Do not completely rely on the outcomes of the analysis. There are limitations. The code that was used to process, filter and analyze the data is available here and has limitations.</p>
        </div>
        <div class="modal-footer justify-content-between flex-wrap">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="privacy-check">
            <label class="form-check-label" for="privacy-check">
              I agree to the ethics and privacy instructions.
            </label>
          </div>
          <button class="btn btn-primary" data-close="notice">Continue</button>
        </div>
      </div>
    </div>
  </div>

  <div class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center bg-dark bg-opacity-75" id="processingOverlay" aria-hidden="true">
    <div class="bg-white rounded-4 p-4 text-center shadow">
      <p class="label mb-2 text-success">Processing</p>
      <h2 class="h5 mb-3">Analyzing your video</h2>
      <div class="progress" role="progressbar" aria-label="Processing progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="progress-bar progress-bar-striped progress-bar-animated" id="processingProgress" style="width: 0%"></div>
      </div>
      <p class="small text-muted mt-3 mb-1" id="progressStage">Starting pipeline...</p>
      <p class="small text-muted mb-0">This can take a few minutes. Please keep this tab open.</p>
    </div>
  </div>

  <div class="page-content">
    <form method="post" action="{% url 'home' %}" enctype="multipart/form-data" id="homeForm" data-run-url="{% url 'run' %}">
      {% csrf_token %}
      <main id="about">

      <div class="container container-wide py-5">
        <div class="alert alert-danger d-none" id="ajaxErrors" role="alert">
          <ul class="mb-0" id="ajaxErrorsList"></ul>
        </div>
        {% if errors %}
          <div class="alert alert-danger" role="alert">
            <ul class="mb-0">
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        {% if status_message %}
          <div class="alert alert-info" role="alert">
            {{ status_message }}
          </div>
        {% endif %}
        <div class="row g-4 align-items-stretch">
          <div class="col-lg-6 d-grid gap-4">

            <div class="card panel-card border-0 rounded-4 shadow">
              <div class="card-body">
                <p class="text-uppercase text-success fw-semibold small mb-2">Before you upload</p>
                <h2 class="h4 fw-semibold mb-3">Capture checklist for best results</h2>
                <ul class="mb-0 text-muted">
                  <li>Use a stable, landscape camera angle that captures the full body without tilting.</li>
                  <li>Prefer high frame rates (30–120fps) with good lighting and high contrast clothing.</li>
                  <li>Keep the background clear of other people and avoid camera movement during recording.</li>
                  <li>Short, tight clothing improves landmark detection; avoid dark outfits on dark backgrounds.</li>
                  <li>Limit clips to around one minute to keep processing fast.</li>
                </ul>
              </div>
            </div>

            <div class="card panel-card border-0 rounded-4 shadow">
              <div class="card-body">
                <p class="text-uppercase text-success fw-semibold small mb-2">Upload</p>
                <h1 class="h3 fw-semibold">Add a video for analysis</h1>
                <p class="text-muted">Select a video file to begin processing. Use the guidance above to maximize tracking quality.</p>
                <div class="mt-3">
                  <label for="videoUpload" class="form-label">Video file</label>
                  <input class="form-control" type="file" id="videoUpload" name="video" accept="video/*" required>
                  <div class="form-text text-muted">Supported: mp4, mov, avi, mkv, and other common video formats.</div>
                </div>
              </div>
            </div>

          </div>
          <div class="col-lg-6 d-flex">

            <div class="card panel-card image-panel border-0 rounded-4 shadow flex-grow-1 overflow-hidden">
              <img src="{% static 'humanpose.png' %}" alt="KinetIQ preview" class="image-cover">
            </div>

          </div>
        </div>

        <div class="row g-4 mt-3">
          <div class="col-12">
            <div class="card panel-card border-0 rounded-4 shadow">
              <div class="card-body">
                <p class="text-uppercase text-success fw-semibold small mb-2">Extra parameters</p>
                <h2 class="h4 mb-3">Participant details</h2>
                <div class="row row-cols-1 row-cols-md-2 g-3">
                  <div class="col">
                    <label for="height" class="form-label">Height (m)</label>
                    <input type="number" class="form-control" id="height" name="height" min="0" step="0.01" placeholder="e.g. 1.78">
                  </div>
                  <div class="col">
                    <label for="mass" class="form-label">Mass (kg)</label>
                    <input type="number" class="form-control" id="mass" name="mass" min="0" step="0.1" placeholder="e.g. 75">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="card panel-card border-0 rounded-4 shadow">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between gap-3">
                  <div>
                    <p class="text-uppercase text-success fw-semibold small mb-1">Pipeline</p>
                    <h2 class="h4 mb-0">Pipeline settings</h2>
                    <p class="text-muted small mb-0">Recommended: leave defaults unless you know what you're doing.</p>
                  </div>
                  <button class="btn btn-link text-primary p-0" type="button" data-bs-toggle="collapse" data-bs-target="#pipelineOptions" aria-expanded="false" aria-controls="pipelineOptions" data-collapse-toggle data-label-show="Show pipeline settings" data-label-hide="Hide pipeline settings" data-icon-collapsed="bi-chevron-down" data-icon-expanded="bi-chevron-up" aria-label="Show pipeline settings">
                    <i class="bi bi-chevron-down fs-4" aria-hidden="true" data-collapse-icon></i>
                    <span class="visually-hidden" data-collapse-label>Show pipeline settings</span>
                  </button>
                </div>
                <div class="collapse mt-3" id="pipelineOptions">
                  <div class="row row-cols-1 row-cols-md-4 g-3">
                    <div class="col">
                      <label for="visibilityMin" class="form-label">Visibility threshold</label>
                      <input type="number" class="form-control" id="visibilityMin" name="visibility_min" min="0" max="1" step="0.01" value="0.1">
                    </div>
                    <div class="col">
                      <label for="augmentationCycles" class="form-label">Augmentation cycles</label>
                      <input type="number" class="form-control" id="augmentationCycles" name="augmentation_cycles" min="1" step="1" value="20">
                    </div>
                    <div class="col">
                      <label for="jointAngleSmooth" class="form-label">Joint angle smooth window</label>
                      <input type="number" class="form-control" id="jointAngleSmooth" name="joint_angle_smooth_window" min="1" step="1" value="9">
                    </div>
                    <div class="col">
                      <label for="temporalSmoothing" class="form-label">Temporal smoothing window — Experimental Feature</label>
                      <input type="number" class="form-control" id="temporalSmoothing" name="temporal_smoothing" min="0" step="1" value="3">
                    </div>
                  </div>
                  <div class="row row-cols-1 row-cols-md-2 g-3 mt-2">
                    <div class="col">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="estimateMissing" name="estimate_missing" checked>
                        <label class="form-check-label" for="estimateMissing">Estimate missing input markers</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="forceComplete" name="force_complete" checked>
                        <label class="form-check-label" for="forceComplete">Force-complete augmented markers</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="mainRefiner" name="main_refiner">
                        <label class="form-check-label" for="mainRefiner">Enable MainRefiner (depth + joint refinement) — Experimental Feature</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="computeAllAngles" name="compute_all_joint_angles" checked>
                        <label class="form-check-label" for="computeAllAngles">Compute all joint angles</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="plotAllAngles" name="plot_all_joint_angles">
                        <label class="form-check-label" for="plotAllAngles">Plot all joint angles</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="saveAngleComparison" name="save_angle_comparison">
                        <label class="form-check-label" for="saveAngleComparison">Save left/right angle comparison</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showAllMarkers" name="show_all_markers">
                        <label class="form-check-label" for="showAllMarkers">Show low-visibility markers</label>
                      </div>
                    </div>
                    <div class="col">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showVideo" name="show_video">
                        <label class="form-check-label" for="showVideo">Show video preview while processing</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="exportPreview" name="export_preview" checked>
                        <label class="form-check-label" for="exportPreview">Export preview video</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="plotLandmarks" name="plot_landmarks">
                        <label class="form-check-label" for="plotLandmarks">Plot raw landmarks</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="plotAugmented" name="plot_augmented">
                        <label class="form-check-label" for="plotAugmented">Plot augmented TRC output</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="fixHeader" name="fix_header">
                        <label class="form-check-label" for="fixHeader">Fix TRC header metadata</label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="card panel-card border-0 rounded-4 shadow">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between gap-3">
                  <div>
                    <p class="text-uppercase text-success fw-semibold small mb-1">Advanced</p>
                    <h2 class="h4 mb-0">Model paths</h2>
                    <p class="text-muted small mb-0">Override model checkpoints if needed.</p>
                  </div>
                  <button class="btn btn-link text-primary p-0" type="button" data-bs-toggle="collapse" data-bs-target="#constraintTuning" aria-expanded="false" aria-controls="constraintTuning" data-collapse-toggle data-label-show="Show constraint tuning" data-label-hide="Hide constraint tuning" data-icon-collapsed="bi-chevron-down" data-icon-expanded="bi-chevron-up" aria-label="Show constraint tuning">
                    <i class="bi bi-chevron-down fs-4" aria-hidden="true" data-collapse-icon></i>
                    <span class="visually-hidden" data-collapse-label>Show constraint tuning</span>
                  </button>
                </div>
                <div class="collapse mt-3" id="constraintTuning">
                  <div class="row row-cols-1 row-cols-md-3 g-3">
                    <div class="col">
                      <label for="depthModelPath" class="form-label">Depth model path</label>
                      <input type="text" class="form-control" id="depthModelPath" name="depth_model_path" placeholder="models/checkpoints/best_depth_model.pth">
                    </div>
                    <div class="col">
                      <label for="jointModelPath" class="form-label">Joint model path</label>
                      <input type="text" class="form-control" id="jointModelPath" name="joint_model_path" placeholder="models/checkpoints/best_joint_model.pth">
                    </div>
                    <div class="col">
                      <label for="mainRefinerPath" class="form-label">Main refiner path</label>
                      <input type="text" class="form-control" id="mainRefinerPath" name="main_refiner_path" placeholder="models/checkpoints/best_main_refiner.pth">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-4 mt-3">
          <div class="col-12">
            <div class="card panel-card border-0 rounded-4 shadow">
              <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
                <div class="form-check mb-0">
                  <input class="form-check-input" type="checkbox" value="accepted" id="consent-check" name="consent" required>
                  <label class="form-check-label" for="consent-check">
                    The subject in the recorded clip agrees with this analysis
                  </label>
                </div>
                <button class="btn btn-primary" type="submit" id="analyzeBtn">Analyse Video</button>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="card panel-card border-0 rounded-4 shadow">
              <div class="card-body">
                <p class="text-uppercase text-success fw-semibold small mb-2">History</p>
                <h2 class="h4 mb-3">Open a previous run</h2>
                <div class="row g-3 align-items-end">
                  <div class="col-md-8">
                    <label for="previousRunSelect" class="form-label">Saved results</label>
                    <div class="form-text text-muted mb-2">Browse previously processed sessions from data/output/.</div>
                    <select class="form-select" id="previousRunSelect" data-results-template="{% url 'results' run_key='__RUN_KEY__' %}" {% if not previous_runs %}disabled{% endif %}>
                      <option value="" disabled selected>Select a run...</option>
                      {% for run in previous_runs %}
                        <option value="{{ run.run_key }}" data-modified="{{ run.modified_time }}">{{ run.display_name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-4 d-flex flex-column align-items-md-end align-items-start gap-2">
                    <div class="form-text text-muted" id="previousRunTimestamp">Last updated: --</div>
                    <button class="btn btn-outline-primary w-100" type="button" id="openPreviousRun" {% if not previous_runs %}disabled{% endif %}>Open results</button>
                  </div>
                </div>
                <p class="small text-muted mt-3 mb-0 {% if previous_runs %}d-none{% endif %}" id="previousRunsEmpty">No previous runs found yet.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    </form>
  </div>
</body>
</html>
