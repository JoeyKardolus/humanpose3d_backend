{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <title>KinetIQ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'styles.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
  <script defer src="{% static 'main.js' %}"></script>
</head>
<body class="page-body" data-model-status-url="{% url 'api_models_status' %}" data-model-download-url="{% url 'api_models_download' %}">
  <div class="modal fade" id="instructionsModal" tabindex="-1" aria-labelledby="instructionsTitle" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <p class="label mb-1 text-success">Instructions</p>
            <h2 class="modal-title h4 fw-semibold" id="instructionsTitle">Read before you continue</h2>
          </div>
        </div>
        <div class="modal-body">
          <p class="fst-italic">This application uses computer vision to identify anatomical landmarks in estimated 3D space.</p>
          <p class="label fw-medium">Recording Tips</p>
          <ul class="mb-0">
            <li><strong>Clothing:</strong> Tight, short, high-contrast</li>
            <li><strong>Lighting:</strong> Bright, even illumination</li>
            <li><strong>Resolution:</strong> HD is fine, 4K not needed</li>
            <li><strong>Framing:</strong> Landscape, full body visible, camera level and steady</li>
            <li><strong>Background:</strong> No other people visible</li>
            <li><strong>Angle:</strong> ~45° frontal-lateral for best coverage</li>
            <li><strong>Duration:</strong> Max 1 minute</li>
          </ul>
        </div>
        <div class="modal-footer justify-content-between flex-wrap">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="instructions-check">
            <label class="form-check-label" for="instructions-check">
              I have read and accept these instructions.
            </label>
          </div>
          <button class="btn btn-primary" data-next="notice">Continue</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="noticeModal" tabindex="-1" aria-labelledby="noticeTitle" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <p class="label mb-1 text-success">Quick Note</p>
            <h2 class="modal-title h4 fw-semibold" id="instructionsTitle">Ethics and privacy instructions</h2>
          </div>
        </div>
        <div class="modal-body">
          <ul class="mb-0">
            <li>Obtain <strong>informed consent</strong> from the recorded subject</li>
            <li>Delete videos after analysis if they contain sensitive data</li>
            <li>Results are estimates — <strong>do not use for clinical decisions</strong></li>
          </ul>
        </div>
        <div class="modal-footer justify-content-between flex-wrap">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="privacy-check">
            <label class="form-check-label" for="privacy-check">
              I confirm participant consent was obtained.
            </label>
          </div>
          <button class="btn btn-primary" data-close="notice">Continue</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modelsModal" tabindex="-1" aria-labelledby="modelsTitle" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <p class="label mb-1 text-success">Setup</p>
            <h2 class="modal-title h4 fw-semibold" id="modelsTitle">Download model assets</h2>
          </div>
        </div>
        <div class="modal-body">
          <p>This app needs model files stored in <code>~/.humanpose3d</code>. The following files are missing:</p>
          <ul class="mb-3" id="missingModelsList"></ul>
          <div class="progress mb-3 d-none" id="modelsDownloadProgress" role="progressbar" aria-label="Model download progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%"></div>
          </div>
          <div class="alert alert-danger d-none" id="modelsDownloadError" role="alert"></div>
          <p class="small text-muted mb-0">If you use a custom location, set <code>HUMANPOSE3D_HOME</code> before starting the server.</p>
        </div>
        <div class="modal-footer justify-content-end">
          <button class="btn btn-primary" id="downloadModelsBtn" type="button">Download models</button>
        </div>
      </div>
    </div>
  </div>

  <div class="position-fixed top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center bg-dark bg-opacity-75" id="processingOverlay" aria-hidden="true">
    <div class="bg-white rounded-4 p-4 text-center shadow">
      <p class="label mb-2 text-success">Processing</p>
      <h2 class="h5 mb-3">Analyzing your video</h2>
      <div class="progress" role="progressbar" aria-label="Processing progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="progress-bar progress-bar-striped progress-bar-animated" id="processingProgress" style="width: 0%"></div>
      </div>
      <p class="small text-muted mt-3 mb-1" id="progressStage">Starting pipeline...</p>
      <p class="small text-muted mb-0">This can take a few minutes. Please keep this tab open.</p>
    </div>
  </div>

  <div class="page-content">
    <form method="post" action="{% url 'home' %}" enctype="multipart/form-data" id="homeForm" data-run-url="{% url 'run' %}">
      {% csrf_token %}
      <main id="about">

      <div class="container container-wide py-5">
        <div class="alert alert-danger d-none" id="ajaxErrors" role="alert">
          <ul class="mb-0" id="ajaxErrorsList"></ul>
        </div>
        {% if errors %}
          <div class="alert alert-danger" role="alert">
            <ul class="mb-0">
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
            {% if error_details %}
              <div class="mt-3">
                <button class="btn btn-sm btn-outline-danger" type="button" data-bs-toggle="collapse" data-bs-target="#errorDetails" aria-expanded="false" aria-controls="errorDetails">
                  Show technical details
                </button>
                <div class="collapse mt-2" id="errorDetails">
                  <pre class="bg-dark text-light p-3 rounded small mb-0" style="max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-break: break-word;">{{ error_details }}</pre>
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}
        {% if status_message %}
          <div class="alert alert-info" role="alert">
            {{ status_message }}
          </div>
        {% endif %}
        <div class="row g-4 align-items-stretch">
          <div class="col-lg-6 d-grid gap-4">

            <div class="card panel-card border-0 rounded-4 shadow">
              <div class="card-body">
                <p class="text-uppercase text-success fw-semibold small mb-2">Before you upload</p>
                <h2 class="h4 fw-semibold mb-3">Capture checklist for best results</h2>
                <ul class="mb-0 text-muted small">
                  <li>Landscape, steady camera · Full body visible</li>
                  <li>30–120fps · Good lighting · High-contrast clothing</li>
                  <li>No other people in background · Max 1 minute</li>
                </ul>
              </div>
            </div>

            <div class="card panel-card border-0 rounded-4 shadow">
              <div class="card-body">
                <p class="text-uppercase text-success fw-semibold small mb-2">Upload</p>
                <h1 class="h3 fw-semibold">Add a video for analysis</h1>
                <p class="text-muted">Select a video file to begin processing. Use the guidance above to maximize tracking quality.</p>
                <div class="mt-3">
                  <label for="videoUpload" class="form-label">Video file</label>
                  <input class="form-control" type="file" id="videoUpload" name="video" accept="video/*" required>
                  <div class="form-text text-muted">Supported: mp4, mov, avi, mkv, and other common video formats.</div>
                  <div class="form-text text-muted d-none" id="videoInfo"></div>
                  <div class="form-text text-warning d-none" id="videoDurationWarning">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                    <span></span>
                  </div>
                </div>
              </div>
            </div>

          </div>
          <div class="col-lg-6 d-flex">

            <div class="card panel-card image-panel border-0 rounded-4 shadow flex-grow-1 overflow-hidden">
              <img src="{% static 'humanpose.png' %}" alt="KinetIQ preview" class="image-cover">
            </div>

          </div>
        </div>

        <div class="row g-4 mt-3">
          <div class="col-12">
            <div class="card panel-card border-0 rounded-4 shadow">
              <div class="card-body">
                <p class="text-uppercase text-success fw-semibold small mb-2">Extra parameters</p>
                <h2 class="h4 mb-3">Participant details</h2>
                <div class="row row-cols-1 row-cols-md-2 g-3">
                  <div class="col">
                    <label for="height" class="form-label">Height (m)</label>
                    <input type="number" class="form-control" id="height" name="height" min="0.5" max="2.5" step="0.01" placeholder="e.g. 1.78">
                    <div class="form-text text-muted">Required for metric scale output (0.5-2.5m).</div>
                    <div class="invalid-feedback">Height must be between 0.5 and 2.5 meters.</div>
                  </div>
                  <div class="col">
                    <label for="weight" class="form-label">Weight (kg)</label>
                    <input type="number" class="form-control" id="weight" name="weight" min="10" max="500" step="0.1" placeholder="e.g. 75">
                    <div class="form-text text-muted">Used for biomechanics calculations (10-500kg).</div>
                    <div class="invalid-feedback">Weight must be between 10 and 500 kg.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="card panel-card border-0 rounded-4 shadow">
              <div class="card-body">
                <div class="d-flex align-items-center justify-content-between gap-3">
                  <div>
                    <p class="text-uppercase text-success fw-semibold small mb-1">Pipeline</p>
                    <h2 class="h4 mb-0">Pipeline settings</h2>
                    <p class="text-muted small mb-0">Recommended defaults are pre-selected for best results.</p>
                  </div>
                  <button class="btn btn-link text-primary p-0" type="button" data-bs-toggle="collapse" data-bs-target="#pipelineOptions" aria-expanded="false" aria-controls="pipelineOptions" data-collapse-toggle data-label-show="Show pipeline settings" data-label-hide="Hide pipeline settings" data-icon-collapsed="bi-chevron-down" data-icon-expanded="bi-chevron-up" aria-label="Show pipeline settings">
                    <i class="bi bi-chevron-down fs-4" aria-hidden="true" data-collapse-icon></i>
                    <span class="visually-hidden" data-collapse-label>Show pipeline settings</span>
                  </button>
                </div>
                <div class="collapse mt-3" id="pipelineOptions">
                  <div class="row row-cols-1 row-cols-md-3 g-3 mb-3">
                    <div class="col">
                      <label for="visibilityMin" class="form-label">Visibility threshold</label>
                      <input type="number" class="form-control" id="visibilityMin" name="visibility_min" min="0" max="1" step="0.01" value="0.1">
                      <div class="form-text text-muted">Lower = accept less confident landmarks (0-1, 0.1 recommended).</div>
                      <div class="invalid-feedback">Visibility threshold must be between 0 and 1.</div>
                    </div>
                    <div class="col">
                      <label for="augmentationCycles" class="form-label">Augmentation cycles</label>
                      <input type="number" class="form-control" id="augmentationCycles" name="augmentation_cycles" min="1" step="1" value="20">
                      <div class="form-text text-muted">Multi-cycle averaging for stable output.</div>
                    </div>
                    <div class="col">
                      <label for="jointAngleSmooth" class="form-label">Joint angle smooth window</label>
                      <input type="number" class="form-control" id="jointAngleSmooth" name="joint_angle_smooth_window" min="1" step="1" value="9">
                      <div class="form-text text-muted">Savitzky-Golay filter window size.</div>
                    </div>
                  </div>
                  <div class="row row-cols-1 row-cols-md-3 g-3">
                    <div class="col">
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="estimateMissing" name="estimate_missing" checked>
                        <label class="form-check-label" for="estimateMissing">Estimate missing markers</label>
                        <div class="form-text text-muted">Mirror occluded limbs from visible side.</div>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="forceComplete" name="force_complete">
                        <label class="form-check-label" for="forceComplete">Force-complete markers</label>
                        <div class="form-text text-muted">Estimate shoulder clusters + hip joint centers.</div>
                      </div>
                    </div>
                    <div class="col">
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="computeAllAngles" name="compute_all_joint_angles" checked>
                        <label class="form-check-label" for="computeAllAngles">Compute all joint angles</label>
                        <div class="form-text text-muted">12 ISB-compliant joint angle groups.</div>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="plotAllAngles" name="plot_all_joint_angles" checked>
                        <label class="form-check-label" for="plotAllAngles">Generate joint angle plots</label>
                        <div class="form-text text-muted">Multi-panel PNG visualizations.</div>
                      </div>
                    </div>
                    <div class="col">
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="cameraPof" name="camera_pof">
                        <label class="form-check-label" for="cameraPof">POF 3D reconstruction (experimental)</label>
                        <div class="form-text text-muted">Use Part Orientation Fields instead of MediaPipe depth.</div>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="jointRefinement" name="joint_refinement">
                        <label class="form-check-label" for="jointRefinement">Joint constraint refinement (experimental)</label>
                        <div class="form-text text-muted">Neural model corrects joint angles using learned constraints.</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row g-4 mt-3">
          <div class="col-12">
            <div class="card panel-card border-0 rounded-4 shadow">
              <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
                <div class="form-check mb-0">
                  <input class="form-check-input" type="checkbox" value="accepted" id="consent-check" name="consent" required>
                  <label class="form-check-label" for="consent-check">
                    The subject in the recorded clip agrees with this analysis
                  </label>
                </div>
                <button class="btn btn-primary" type="submit" id="analyzeBtn">Analyse Video</button>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="card panel-card border-0 rounded-4 shadow">
              <div class="card-body">
                <p class="text-uppercase text-success fw-semibold small mb-2">History</p>
                <h2 class="h4 mb-3">Open a previous run</h2>
                <div class="row g-3 align-items-end">
                  <div class="col-md-8">
                    <label for="previousRunSelect" class="form-label">Saved results</label>
                    <div class="form-text text-muted mb-2">Browse previously processed sessions from ~/.humanpose3d/output/.</div>
                    <select class="form-select" id="previousRunSelect" data-results-template="{% url 'results' run_key='__RUN_KEY__' %}" {% if not previous_runs %}disabled{% endif %}>
                      <option value="" disabled selected>Select a run...</option>
                      {% for run in previous_runs %}
                        <option value="{{ run.run_key }}" data-modified="{{ run.modified_time }}">{{ run.display_name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-4 d-flex flex-column align-items-md-end align-items-start gap-2">
                    <div class="form-text text-muted" id="previousRunTimestamp">Last updated: --</div>
                    <button class="btn btn-outline-primary w-100" type="button" id="openPreviousRun" {% if not previous_runs %}disabled{% endif %}>Open results</button>
                  </div>
                </div>
                <p class="small text-muted mt-3 mb-0 {% if previous_runs %}d-none{% endif %}" id="previousRunsEmpty">No previous runs found yet.</p>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="card panel-card border-0 rounded-4 shadow">
              <div class="card-body">
                <p class="text-uppercase text-success fw-semibold small mb-2">References</p>
                <h2 class="h4 mb-3">Open Source & Research</h2>
                <div class="row">
                  <div class="col-md-6">
                    <p class="small text-muted mb-2">This application uses the following open source projects:</p>
                    <ul class="small mb-0">
                      <li><a href="https://github.com/google-ai-edge/mediapipe" target="_blank">MediaPipe</a> — Pose detection (Apache 2.0)</li>
                      <li><a href="https://github.com/perfanalytics/pose2sim" target="_blank">Pose2Sim</a> — Marker augmentation (BSD 3-Clause)</li>
                      <li><a href="https://aistdancedb.ongaaccel.jp/" target="_blank">AIST++ Dataset</a> — Neural model training (CC BY 4.0)</li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <p class="small text-muted mb-2">Research documentation:</p>
                    <div class="d-flex align-items-start gap-3">
                      <div class="flex-shrink-0 text-danger">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-file-earmark-pdf" viewBox="0 0 16 16">
                          <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2M9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5z"/>
                          <path d="M4.603 14.087a.8.8 0 0 1-.438-.42c-.195-.388-.13-.776.08-1.102.198-.307.526-.568.897-.787a7.7 7.7 0 0 1 1.482-.645 20 20 0 0 0 1.062-2.227 7.3 7.3 0 0 1-.43-1.295c-.086-.4-.119-.796-.046-1.136.075-.354.274-.672.65-.823.192-.077.4-.12.602-.077a.7.7 0 0 1 .477.365c.088.164.12.356.127.538.007.188-.012.396-.047.614-.084.51-.27 1.134-.52 1.794a11 11 0 0 0 .98 1.686 5.8 5.8 0 0 1 1.334.05c.364.066.734.195.96.465.12.144.193.32.2.518.007.192-.047.382-.138.563a1.04 1.04 0 0 1-.354.416.86.86 0 0 1-.51.138c-.331-.014-.654-.196-.933-.417a5.7 5.7 0 0 1-.911-.95 11.7 11.7 0 0 0-1.997.406 11.3 11.3 0 0 1-1.02 1.51c-.292.35-.609.656-.927.787a.8.8 0 0 1-.58.029"/>
                        </svg>
                      </div>
                      <div>
                        <p class="small fw-semibold mb-1">HumanPose3D</p>
                        <p class="small text-muted mb-1">Monocular Markerless 3D Pose Analysis for Healthcare</p>
                        <p class="small text-muted mb-2">Joey Kardolus & Max Jansen — Hogeschool Utrecht, 2026</p>
                        <a href="{% static 'research_report.pdf' %}" target="_blank" class="btn btn-sm btn-outline-secondary">
                          Download PDF
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    </form>
  </div>
</body>
</html>
